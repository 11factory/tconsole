require "tconsole/version"
require "tconsole/server"

require "readline"
require "benchmark"
require "drb/drb"

module TConsole
  class Runner

    SERVER_URI = "druby://localhost:8788" 
    # Spawns a new environment. Looks at the results of the environment to determine whether to stop or
    # keep running
    def self.run
      stty_save = `stty -g`.chomp

      # We're only going to handle interrupts on the inner process
      running = true
      trap("SIGINT", "IGNORE");

      # A little welcome
      puts
      puts "Welcome to tconsole. Type 'help' for help."
      puts "Press ^C or type 'exit' to quit."

      # Start the server
      while running
        puts "Starting Server"
        pid = fork do
          server = Server.new

          DRb.start_service(SERVER_URI, server)

          DRb.thread.join
        end

        # Set up our client connection to the server
        server = DRbObject.new_with_uri(SERVER_URI)

        running = server.load_environment

        running = command_loop(server) if running

        server.stop
        puts "Service stopped. Waiting."
        Process.wait2(pid)
      end

      puts
      puts "Exiting. Bye!"
      system("stty", stty_save);
    end

    def self.command_loop(server)
      while line = Readline.readline("tconsole> ", true)
        if line == ""
          # do nothing
        elsif line == "exit"
          return false
        elsif line == "reload"
          return true
        elsif line == "help"
          help
        elsif line == "units"
          server.run_tests(["test/unit/**/*_test.rb"])
        elsif line == "functionals"
          server.run_tests(["test/functional/**/*_test.rb"])
        elsif line == "integration"
          server.run_tests(["test/integration/**/*_test.rb"])
        elsif line == "all"
          server.run_tests(["test/unit/**/*_test.rb", "test/functional/**/*_test.rb", "test/integration/**/*_test.rb"])
        else
          server.run_tests([line])
        end
      end

      return true
    end

    # Prints a list of available commands
    def self.help
      puts
      puts "Available commands:"
      puts
      puts "all          # Run all test types (units, functionals, integration)"
      puts "units        # Run unit tests"
      puts "functionals  # Run functional tests"
      puts "integration  # Run integration tests"
      puts "[filename]   # Run the tests contained in the given file"
      puts "reload       # Reload your Rails environment"
      puts "exit         # Exit the console"
      puts
    end
  end
end
